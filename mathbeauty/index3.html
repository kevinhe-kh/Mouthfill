<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quantum Canvas: Formulaic Art Engine</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #1a1a1a; color: #f0f0f0; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 20px; }
        header { text-align: center; margin-bottom: 20px; }
        h1 { margin: 0; color: #ffffff; font-size: 2.5em; letter-spacing: 2px; }
        p { color: #cccccc; }
        #controls-container { display: flex; flex-direction: column; align-items: center; gap: 15px; margin-bottom: 20px; width: 100%; max-width: 720px; }
        
        #sketch-selector-wrapper {
            width: 100%;
            max-width: 350px;
        }
        
        #sketch-selector {
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
            width: 100%; padding: 12px 40px 12px 16px; font-size: 16px; font-weight: 500;
            color: #fff; background-color: #2c2c2c; border: 1px solid #444; border-radius: 8px;
            cursor: pointer;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23cccccc%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22/%3E%3C/svg%3E');
            background-repeat: no-repeat;
            background-position: right 16px center;
            background-size: 12px;
            transition: border-color 0.2s ease;
        }

        #sketch-selector:hover { border-color: #666; }
        #sketch-selector:focus { outline: none; border-color: #4CAF50; box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.3); }

        .control-wrapper { display: flex; align-items: center; gap: 10px; width: 80%; justify-content: center; }
        .control-wrapper.hidden { display: none; }
        .control-wrapper input[type="range"] { flex-grow: 1; max-width: 400px; cursor: pointer; }
        .control-wrapper input[type="checkbox"] { cursor: pointer; width: 18px; height: 18px; }
        #canvas-container { border: 2px solid #444; border-radius: 8px; padding: 5px; background-color: #282828; line-height: 0; margin-bottom: 20px;}
        
        #code-display-wrapper { width: 100%; max-width: 720px; display: flex; flex-direction: column; align-items: center; }
        #code-display { width: 95%; height: 120px; background-color: #2b2b2b; color: #a9b7c6; border: 1px solid #444; border-radius: 5px; padding: 10px; font-family: 'Courier New', Courier, monospace; font-size: 14px; resize: vertical; }
    </style>
</head>
<body>

    <header>
        <h1>Quantum Canvas</h1>
        <p>An interactive engine for formulaic and generative art.</p>
    </header>

    <div id="controls-container">
        <div id="sketch-selector-wrapper">
            <select id="sketch-selector"></select>
        </div>

        <div class="control-wrapper">
            <label for="speed-slider">速度乘数:</label>
            <input type="range" id="speed-slider" min="1" max="2" value="1" step="0.05">
            <span id="speed-value">1.0x</span>
        </div>
        <div class="control-wrapper">
            <label for="color-toggle">启用彩虹模式:</label>
            <input type="checkbox" id="color-toggle">
        </div>
        <div class="control-wrapper hidden" id="hue-slider-wrapper">
            <label for="hue-speed-slider">颜色速度:</label>
            <input type="range" id="hue-speed-slider" min="1" max="10" value="1" step="0.1">
            <span id="hue-speed-value">1.0</span>
        </div>
    </div>

    <div id="canvas-container"></div>
    
    <div id="code-display-wrapper">
        <p>原始代码:</p>
        <textarea id="code-display" readonly></textarea>
    </div>


    <script>
        // 全局状态变量
        let currentSketch = null;
        let speedMultiplier = 1.0;
        let hueSpeedMultiplier = 1.0;
        let isColorChangeActive = false;
        
        const sketchSelector = document.getElementById('sketch-selector');
        const speedSlider = document.getElementById('speed-slider');
        const speedValueLabel = document.getElementById('speed-value');
        const colorToggle = document.getElementById('color-toggle');
        const hueSliderWrapper = document.getElementById('hue-slider-wrapper');
        const hueSpeedSlider = document.getElementById('hue-speed-slider');
        const hueSpeedValueLabel = document.getElementById('hue-speed-value');
        const codeDisplay = document.getElementById('code-display');

        function applyRainbowColors(p, originalBg, originalStroke) {
            p.background(...originalBg);

            if (isColorChangeActive) {
                p.colorMode(p.HSL, 360, 100, 100, 1);
                
                const time = p.frameCount * 0.05 * hueSpeedMultiplier;
                const hue = p.map(p.sin(time), -1, 1, 0, 360);
                const saturation = p.map(p.cos(time * 0.5), -1, 1, 50, 100);
                const brightness = p.map(p.sin(time * 0.8), -1, 1, 50, 95);
                p.stroke(hue, saturation, brightness);

            } else {
                p.colorMode(p.RGB);
                p.stroke(...originalStroke);
            }
        }

        // =================================================================
        //              从链接中提取并重构的全新动画数据
        // =================================================================
        const sketches = [
            {
                name: "星尘", enName: "Stardust",
                originalCode: `$= [],t=0,draw=_=>{t+=.002;$[0]??createCanvas(w=720,w);background(0,10);stroke(255);$=[...$,...[...Array(9)].map(_=>[p=>(p*p+t%1*2)*9,p=>p*p+t%1*2,p=>p*p].flatMap(f=>[f(random()),f(random())]))];$.map(v=>line(v[0],v[1],v[2],v[3],v[4],v[5]))}`,
                originalBg: [0, 10], originalStroke: [255],
                setup: function(p) { p.createCanvas(720, 720); this.t = 0; this.lines = []; },
                draw: function(p) {
                    applyRainbowColors(p, this.originalBg, this.originalStroke);
                    this.t += 0.002 * speedMultiplier;
                    const newLines = [...Array(9)].map(() => {
                        const f1 = p => (p * p + this.t % 1 * 2) * 9;
                        const f2 = p => p * p + this.t % 1 * 2;
                        const f3 = p => p * p;
                        return [f1(p.random()), f2(p.random()), f3(p.random())].flatMap(f => [f, f]);
                    });
                    this.lines.push(...newLines);
                    this.lines.forEach(v => p.line(v[0], v[1], v[2], v[3], v[4], v[5]));
                }
            },
            {
                name: "宇宙之网", enName: "Cosmic Web",
                originalCode: `$= [],t=0,draw=_=>{t+=.01;$[0]??createCanvas(w=720,w);background(0,10);stroke(255);$=[...$,...[...Array(4)].map(_=>[...Array(6)].map(_=>w/2+tan(t+random(PI))*300))];$.map(v=>line(...v))}`,
                originalBg: [0, 10], originalStroke: [255],
                setup: function(p) { p.createCanvas(720, 720); this.t = 0; this.lines = []; },
                draw: function(p) {
                    applyRainbowColors(p, this.originalBg, this.originalStroke);
                    this.t += 0.01 * speedMultiplier;
                    const newLines = [...Array(4)].map(() => 
                        [...Array(6)].map(() => p.width / 2 + p.tan(this.t + p.random(p.PI)) * 300)
                    );
                    this.lines.push(...newLines);
                    this.lines.forEach(v => p.line(...v));
                }
            },
            {
                name: "星云", enName: "Nebula",
                originalCode: `$= [],t=0,draw=_=>{t+=.002;$[0]??createCanvas(w=720,w);background(0,10);stroke(255);$=[...$,...[...Array(9)].map(_=>[...Array(6)].map(p=>w/2+tan(t+noise(p,t)*PI)*300))];$.map(v=>line(...v))}`,
                originalBg: [0, 10], originalStroke: [255],
                setup: function(p) { p.createCanvas(720, 720); this.t = 0; this.lines = []; },
                draw: function(p) {
                    applyRainbowColors(p, this.originalBg, this.originalStroke);
                    this.t += 0.002 * speedMultiplier;
                    const newLines = [...Array(9)].map(() => 
                        [...Array(6)].map(px => p.width / 2 + p.tan(this.t + p.noise(px, this.t) * p.PI) * 300)
                    );
                    this.lines.push(...newLines);
                    this.lines.forEach(v => p.line(...v));
                }
            },
            {
                name: "引力透镜", enName: "Gravity Lens",
                originalCode: `$= [],t=0,draw=_=>{t+=.01;$[0]??createCanvas(w=720,w);background(0,10);stroke(255);$=[...$,...[...Array(4)].map(_=>[...Array(6)].map(_=>w/2+1/(t-noise(t,random())*4)*300))];$.map(v=>line(...v))}`,
                originalBg: [0, 10], originalStroke: [255],
                setup: function(p) { p.createCanvas(720, 720); this.t = 0; this.lines = []; },
                draw: function(p) {
                    applyRainbowColors(p, this.originalBg, this.originalStroke);
                    this.t += 0.01 * speedMultiplier;
                    const newLines = [...Array(4)].map(() => 
                        [...Array(6)].map(() => p.width / 2 + 1 / (this.t - p.noise(this.t, p.random()) * 4) * 300)
                    );
                    this.lines.push(...newLines);
                    this.lines.forEach(v => p.line(...v));
                }
            },
            {
                name: "万花筒", enName: "Kaleidoscope",
                originalCode: `$= [],t=0,draw=_=>{t+=.01;$[0]??createCanvas(w=720,w);background(0,10);stroke(255);$=[...$,...[...Array(4)].map(_=>[...Array(6)].map(_=>(w/2+tan(t+random(PI))*300)%w))];$.map(v=>line(...v))}`,
                originalBg: [0, 10], originalStroke: [255],
                setup: function(p) { p.createCanvas(720, 720); this.t = 0; this.lines = []; },
                draw: function(p) {
                    applyRainbowColors(p, this.originalBg, this.originalStroke);
                    this.t += 0.01 * speedMultiplier;
                    const newLines = [...Array(4)].map(() => 
                        [...Array(6)].map(() => (p.width / 2 + p.tan(this.t + p.random(p.PI)) * 300) % p.width)
                    );
                    this.lines.push(...newLines);
                    this.lines.forEach(v => p.line(...v));
                }
            }
        ];

        // 事件监听器
        speedSlider.addEventListener('input', (e) => { speedMultiplier=parseFloat(e.target.value); speedValueLabel.textContent=`${speedMultiplier.toFixed(1)}x`; });
        hueSpeedSlider.addEventListener('input', (e) => { hueSpeedMultiplier=parseFloat(e.target.value); hueSpeedValueLabel.textContent=hueSpeedMultiplier.toFixed(1); });
        colorToggle.addEventListener('change', (e) => { isColorChangeActive=e.target.checked; hueSliderWrapper.classList.toggle('hidden',!isColorChangeActive); });
        
        sketchSelector.addEventListener('change', (e) => {
            const selectedIndex = e.target.value;
            runSketch(sketches[selectedIndex], selectedIndex);
        });

        function runSketch(sketchData, index) {
            if (currentSketch) {
                currentSketch.remove();
            }
            
            sketchSelector.value = index;
            codeDisplay.value = sketchData.originalCode;

            currentSketch = new p5((p) => {
                p.sketchData = {};
                p.sketchData.originalBg = sketchData.originalBg;
                p.sketchData.originalStroke = sketchData.originalStroke;
                p.sketchData.setup = sketchData.setup.bind(p.sketchData);
                p.sketchData.draw = sketchData.draw.bind(p.sketchData);
                p.setup = () => { p.sketchData.setup(p); };
                p.draw = () => { p.sketchData.draw(p); };
            }, 'canvas-container');
        }

        // 创建下拉列表选项
        sketches.forEach((sketchData, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = `${sketchData.name} / ${sketchData.enName}`;
            sketchSelector.appendChild(option);
        });

        // 自动运行第一个动画
        if (sketches.length > 0) {
            runSketch(sketches[0], 0);
        }
    </script>
</body>
</html>
